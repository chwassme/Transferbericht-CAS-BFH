---
title: "Transferbericht 'Ursache tödlicher Unfälle im Kanton Zürich'"
output: html_document
---

```{r warning=FALSE, message=FALSE, echo=FALSE}
library(magrittr)
library(dplyr)
library(lubridate)
library(tidyr)
library(stargazer)
library(car)
library(moments)
library(stringr)
library(leaps)

basedir <- '/Users/chwassme/Dropbox/dev/edu.self/cas/010_Kurse/005-LinReg/Transferbericht/data/';
```

# Datenquellen

## Unfalldaten
- https://opendata.swiss/de/dataset/polizeilich-registrierte-verkehrsunfalle-im-kanton-zurich
- https://opendata.swiss/de/dataset/polizeilich-registrierte-verkehrsunfalle-im-kanton-zurich/resource/1b2a47b7-ea16-4264-9bb6-d743cebdbd76

Die Verkehrsunfallstatistik des Kantons Zürich (VUSTA) enthält die Strassenverkehrsunfälle mit Personen- und Sachschäden, die durch die Kantonspolizei Zürich, die Dienstabteilung Verkehr der Stadt Zürich sowie die Stadtpolizei Winterthur registriert wurden. Sie wird einmal jährlich aktualisiert, jeweils gegen Ende des ersten Quartals des Folgejahres.

Zu jedem Strassenverkehrsunfall sind der Unfallort (geokodiert), das Jahr, der Monat, der Wochentag, die Unfallstunde, die Strassenart, der Unfalltyp (ab 1. Juli 2015 inklusive Bagatellunfälle zB. Parkschäden), die Unfallbeteiligung ('Fussgänger', 'Velo (ohne E-Bikes)', 'Motorrad') und die Unfallschwerekategorie verfügbar. Detaillierte Definitionen der Variabeln sind in der Ressource "Minimales Geodatenmodell Strassenverkehrsunfallorte (ASTRA)" dokumentiert.

Die Datei "KTZH_00000718_00001783.csv" wurde am 11.03.2022 heruntergeladen. Am 16.03.2022 wurde eine neue Version veröffentlicht, welche mit dem Script nicht kompatibel ist.

## Motorisierter Individualverkehr
- https://data.stadt-zuerich.ch/dataset/sid_dav_verkehrszaehlung_miv_od2031

Die hier verfügbaren Datensätze beinhalten die täglich aktualisierten Messwerte zum motorisierten Individualverkehr (MIV) in der Stadt Zürich, welche von den zahlreichen Zählstellen der Dienstabteilung Verkehr (DAV) gemessen wurden.

Die Aktualisierung beinhaltet jeweils die Daten von vorgestern (z.B. am 17.1.2021 werden die Daten bis und mit dem vollendeten 15.1.2021 geliefert). Bis spätestens 08:00 Uhr sind die neuesten Daten verfügbar.

Zu einer Messstelle gehören mehrere Zählstellen, welche wiederum Messungen mit sogenannten Detektoren vornehmen. In den vorliegenden Datensätzen sind die Messwerte pro Zählstelle enthalten. Für jede Zählstelle gibt es einen detaillierten PDF-Situationsplan in der Datei "Zaehlstellen_Detail.zip", welcher u.a. die genaue Lage der Detektoren anzeigt.

## Fussgänger und Veloverkehr
- https://data.stadt-zuerich.ch/dataset/ted_taz_verkehrszaehlungen_werte_fussgaenger_velo

Die täglich aktalisierten **Zähldaten** werden vom Tiefbauamt der Stadt Zürich in eigener Regie erhoben. Die Zählstellen sind über das Stadtgebiet verteilt. Die Standorte sind auch über das [Geodatenportal](https://www.stadt-zuerich.ch/geodaten/download/Standorte_der_automatischen_Fuss__und_Velozaehlungen) erhältlich und können über das Attribut FK_ZAEHLER in Beziehung gesetzt werden. Die Erfassung des **Veloverkehrs** erfolgt mittels im Strassenbelag eingelassenen **Induktionsschlaufen**. Der **Fussverkehr** wird durch **passive Infrarotstrahlung** gezählt.

## Meteodaten
- https://data.stadt-zuerich.ch/dataset/ugz_meteodaten_stundenmittelwerte

Der Datensatz umfasst Stundenwerte ab 1992 bis zur letzten aktuellen Stunde aufgeteilt in Jahresdateien. Darin enthalten sind die Stationen Stampfenbachstrasse, Schimmelstrasse und Rosengartenstrasse. Gemessen wird der Luftdruck (p), die Niederschlagsdauer (RainDur), die Globalstrahlung (StrGlo), die Temperatur (T), die relative Luftfeuchtigkeit (Hr), die Windrichtung, die Vektor und Skalar Windgeschwindigkeit. Vor 2018 sind die Skalar Windgeschwindigkeiten aus den 30 Minuten Vektor Daten gerechnet worden.
s
Die Stundenwerte des laufenden Jahres werden jeweils 30 Minuten nach der vollen Stunde aktualisiert.

## Luftqualität
- https://data.stadt-zuerich.ch/dataset/ugz_luftschadstoffmessung_stundenwerte

Dieses Dataset umfasst Stundenmesswerte seit 1983 bis zur letzten aktuellen Stunde, aufgeteilt in Jahresdateien. Darin enthalten sind die Stundenmittelwerte des entsprechenden Jahres für die Stationen Stampfenbachstrasse, Schimmelstrasse, Rosengartenstrasse und Heubeeribüel. Gemessen wird Ozon (O3), Stickoxide (NOx), Stickstoffmonoxid (NO), Stickstoffdioxid (NO2), Feinstaub (PM10 und PM2.5), Kohlenmonoxid (CO) und Schwefeldioxid (SO2) wo jeweils in genügender Qualität vorhanden.

Die Stundenmittelwerte des laufenden Jahres werden jeweils 30 Minuten nach der vollen Stunde aktualisiert.



# Lineare Regression "Unfalldaten"

## Daten einlesen

```{r}
normalizeText <- function(x, length = 9) {
  res <- str_trim(x, side = 'both')
  res <- str_replace_all(res, ' ', '_')
  substr(res, 0, length)
}

# 'basedir' ist eine lokale Variable und verweist auf ein Verzeichnis in meiner Dropbox
accidentsFile <- paste0(basedir, 'KTZH_00000718_00001783.csv')
rawAccident <- read.csv(accidentsFile, header = TRUE, sep = ';', stringsAsFactors = TRUE)

accidentData <- rawAccident %>%
  select(AccidentUID, AccidentType_de, AccidentSeverityCategory_de, RoadType_de, MunicipalityCode, AccidentYear, AccidentMonth, AccidentWeekDay, AccidentHour) %>%
  mutate(AccidentType_de = normalizeText(AccidentType_de)) %>%
  mutate(AccidentSeverityCategory_de = normalizeText(AccidentSeverityCategory_de, 20)) %>%
  mutate(RoadType_de = normalizeText(RoadType_de)) %>%
  mutate(YearMonth = paste(AccidentYear, sprintf("%02.f", AccidentMonth), sep = '-'))

# Aus Gründen der Übersichtlichkeit wird die UID des Unfalls ausgeblendet
head(accidentData %>% select(-AccidentUID))
## Daten einlesen
```

## Unfall nach Typ
```{r}
accidentByType <- table(accidentData$YearMonth, accidentData$AccidentType) %>%
  as.data.frame() %>%
  pivot_wider(names_from = Var2, values_from = Freq, values_fill = 0) %>%
  rename(YearMonth = Var1)
tail(accidentByType, 12)
```
## Unfall nach Schwerekategorie

```{r}
accidentBySeverity <- table(accidentData$YearMonth, accidentData$AccidentSeverityCategory) %>%
  as.data.frame() %>%
  pivot_wider(names_from = Var2, values_from = Freq, values_fill = 0) %>%
  rename(YearMonth = Var1)
tail(accidentBySeverity, 12)

```
## Unfall nach Strassentyp

```{r}
accidentByRoadType <- table(accidentData$YearMonth, accidentData$RoadType) %>%
  as.data.frame() %>%
  pivot_wider(names_from = Var2, values_from = Freq, values_fill = 0) %>%
  rename(YearMonth = Var1)
tail(accidentByRoadType, 12)

```
## Unfall nach Stunde

Wird in der Regressionsanalyse nicht weiter verwendet.

```{r}
accidentByHour <- table(accidentData$YearMonth, accidentData$AccidentHour) %>%
  as.data.frame() %>%
  pivot_wider(names_from = Var2, values_from = Freq, values_fill = 0) %>%
  rename(YearMonth = Var1)
tail(accidentByHour, 12)

```
## Unfall nach Wochentag

```{r}
accidentByWeekDay <- table(accidentData$YearMonth, accidentData$AccidentWeekDay) %>%
  as.data.frame() %>%
  pivot_wider(names_from = Var2, values_from = Freq, values_fill = 0) %>%
  rename(YearMonth = Var1) %>%
  rename(Mo = aw401, Di = aw402, Mi = aw403, Do = aw404, Fr = aw405, Sa = aw406, So = aw407)
tail(accidentByWeekDay, 12)
```
## Zusammenfassung

Das Datenset erstreckt sich über 120 Monate (Januar 2011 bis Dezember 2022) und enthält rund 150k Unfälle (pro Monat rund 1200).

```{r }
accidentByMonth <- accidentData %>%
  group_by(YearMonth) %>%
  summarise(TotalAccidents = n())
tail(accidentByMonth, 12)
NROW(accidentByMonth)
mean(accidentByMonth$TotalAccidents)
sum(accidentByMonth$TotalAccidents)
min(accidentByMonth$YearMonth)
max(accidentByMonth$YearMonth)
```
## Alle Daten zusammenführen

```{r}
accidentFreq <- accidentByMonth %>%
  # full_join(accidentByHour, by = 'YearMonth') %>%
  full_join(accidentByWeekDay, by = 'YearMonth') %>%
  full_join(accidentByType, by = 'YearMonth') %>%
  full_join(accidentBySeverity, by = 'YearMonth') %>%
  full_join(accidentByRoadType, by = 'YearMonth')

# Sanity checks
head(accidentFreq)

# Still 120 months?
NROW(accidentFreq) == 120
```
## Regressionsanalyse

Hypothese / Untersuchungsgegenstand: Welches sind die Haupteinfluss-Faktoren für "Unfall_mit_Getöteten"?

Mittel: Step-wise Vorwärts- und Rückwärts-Selektion sowie Suche in "beiden Richtungen" mit dem Akaike‘s AIC-Kriterium und dem Schwarz Informationskriterium (BIC).


### Vorbereitungen

```{r}
# Entfernen nicht mehr benötigte Daten
accidents <- accidentFreq %>%
  select(-YearMonth, -TotalAccidents, -Unfall_mit_Sachschad, -Unfall_mit_Leichtver, -Unfall_mit_Schwerver)

# Interzeptmodell als Ausgangmodell
nullModel <- lm(Unfall_mit_Getöteten ~ 1, data = accidents)
fullModel <- lm(Unfall_mit_Getöteten ~ ., data = accidents)

N <- NROW(accidents)
```
### AIC-Kriterium

```{r}
forwardModelAIC <- step(nullModel,
                        direction = "forward",
                        scope = formula(fullModel), k = 2, trace = 0)

backwardModelAIC <- step(fullModel,
                         direction = "backward",
                         scope = formula(fullModel), k = 2, trace = 0)

bothModelAIC <- step(fullModel,
                     direction = "both",
                     data = accidents, k = 2, trace = 0)
```

**Interpretation**

Mit allen drei Verfahren kommen die gleichen Regressoren heraus mit gleichem AIC:

```{r}
paste(AIC(forwardModelAIC), AIC(backwardModelAIC), AIC(bothModelAIC), sep = ", ")
paste(attr(forwardModelAIC$terms, "term"), sep = ", ")
paste(attr(backwardModelAIC$terms, "term"), sep = ", ")
paste(attr(bothModelAIC$terms, "term"), sep = ", ")

finalModelAIC <- lm(Unfall_mit_Getöteten ~
                      Fr +
                        Sa +
                        So +
                        Abbiegeun +
                        Frontalko +
                        Fussgänge +
                        Tierunfal +
                        Autobahn, data = accidents)
summary(finalModelAIC)
layout(matrix(1:4, 2, 2))
plot(finalModelAIC)
jarque.test(finalModelAIC$residuals)
```

Die Residuen sind normalverteilt. Das Modell kann verwendet werden, siehe Analyse / Fazit.

### BIC-Kriterium
```{r}
forwardModelBIC <- step(nullModel,
                        direction = "forward",
                        scope = formula(fullModel), k = log(N), trace = 0)

backwardModelBIC <- step(fullModel,
                         direction = "backward",
                         scope = formula(fullModel), k = log(N), trace = 0)

bothModelBIC <- step(fullModel,
                     direction = "both",
                     data = accidents, k = log(N), trace = 0)

```

**Interpretation**

Mit allen drei Verfahren kommen die gleichen Regressoren heraus mit gleichem BIC:

```{r}
paste(BIC(forwardModelAIC), BIC(backwardModelAIC), BIC(bothModelAIC), sep = ", ")
paste(attr(forwardModelAIC$terms, "term"), sep = ", ")
paste(attr(backwardModelAIC$terms, "term"), sep = ", ")
paste(attr(bothModelAIC$terms, "term"), sep = ", ")

finalModelBIC <- lm(Unfall_mit_Getöteten ~ Fr + Abbiegeun, data = accidents)
summary(finalModelBIC)
layout(matrix(1:4, 2, 2))
plot(finalModelBIC)
jarque.test(finalModelBIC$residuals)
```
Die Residuen sind _nicht_ normalverteilt. Das Model wird nicht weiter verfolgt.

## Analyse und Fazit

Uns ist bewusst, dass mit der vorliegenden Methode keine belastbaren, geschweige denn kausalen Zusammenhänge hergeleitet werden können. Zumal die Kennzahl R2 mit rund 0.25 darauf hinweist, dass das gewählte Regressionsmodell den Regressanden "Unfall_mit_Getöteten" nur ungenügend schwach erklären kann. Dennoch scheint sich zu bewahrheiten, dass die Wochentage Fr (\*\*\*), Sa (.) und So (nicht signifikant), sowie Abbiegeunfälle (\*), Frontalkollisionen (.), Unfälle mit Fussgängern (\*) und auf Autobahnen (\*\*) den stärksten Einfluss auf Unfälle mit Todesopfern haben. Dies entspricht unserer Ansicht nach durchaus den Erwartungen. Einzig der Einflussfaktor "Unfälle mit Tieren" (.) kommt etwas unerwartet.

_(In Klammern Signifikanzcodes: 0 '\*\*\*' 0.001 '\*\*' 0.01 '\*' 0.05 '.' 0.1)_

Das Modell, welches mittels BIC gefunden wurde, wurde verworfen: Die Residuen sind nicht normalverteilt.

Alle Aussagen basieren auf einem Signifikanzniveau von 95%.

Interessant wäre vermutlich die Einflussfaktoren in den Gruppen einzeln zu analysieren, also Wochentage, Unfallart, Strassentyp und ggf. auch Stunde; als auch mit anderen Schwerekategorien zu untersuchen.